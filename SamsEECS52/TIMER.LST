8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\ASMSTU~1\ASM86.EXE TIMER.ASM M1 DB EP


LOC  OBJ                  LINE     SOURCE

                             1            NAME  timer
                             2     
                             3     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             4     ;                                                                            ;
                             5     ;                                    timer                                   ;
                             6     ;                           Timer Event Handler                   ;
                             7     ;                                                                            ;
                             8     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             9     
                            10     ; Description:      This program an event handler (interrupt service routine).
                            11     ;                   It handles the timer overflow interrupt, keeping track of elapsed
                                    time.
                            12     ;
                            13     ; Input:            None.
                            14     ; Output:           None.
                            15     ; User Interface:   Call function elapsed_time()
                            16     ; Error Handling:   None.
                            17     ;
                            18     ; Algorithms:       None.
                            19     ; Data Structures:  None.
                            20     ;
                            21     ; Revision History:
                            22     
                            23     ;     5/30/08 copied from EE/CS 51 code
                            24     
                            25     ; local include files
                            26 +1  $INCLUDE(boolean.INC)
                      =1    27     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    28     ;                                                                            ;
                      =1    29     ;                                  boolean.INC                               ;
                      =1    30     ;                             Boolean Definitions                            ;
                      =1    31     ;                                 Include File                               ;
                      =1    32     ;                                                                            ;
                      =1    33     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    34     
                      =1    35     ; This file contains the boolean definitions for the 80188 MP3 Player.
                      =1    36     ;
                      =1    37     ; Revision History:
                      =1    38     
                      =1    39     ;     5/2/2008 Samuel Yang     
                      =1    40     
                      =1    41     
  0001                =1    42     TRUE EQU 1h
  0000                =1    43     FALSE EQU 0h
                            44 +1  $INCLUDE(timer.INC)
                      =1    45     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    46     ;                                                                            ;
                      =1    47     ;                                  timer.INC                                ;
                      =1    48     ;                              Timer Event Handler                         ;
                      =1    49     ;                                 Include File                               ;
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    2


LOC  OBJ                  LINE     SOURCE

                      =1    50     ;                                                                            ;
                      =1    51     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    52     
                      =1    53     ; This file contains the definitions for the Timer Event Handler
                      =1    54     ; program (timer.ASM).
                      =1    55     ;
                      =1    56     ; Revision History:
                      =1    57     
                      =1    58     ;     5/30/2008 Samuel Yang     copied from EE/CS 51 code
                      =1    59     
                      =1    60     
                      =1    61     
                      =1    62     ; Timer Definitions
                      =1    63     
                      =1    64     ; Addresses
  FF56                =1    65     Tmr0Ctrl        EQU     0FF56H          ;address of Timer 0 Control Register
  FF52                =1    66     Tmr0MaxCntA     EQU     0FF52H          ;address of Timer 0 Max Count A Register
  FF50                =1    67     Tmr0Count       EQU     0FF50H          ;address of Timer 0 Count Register
                      =1    68     
                      =1    69     
                      =1    70     ; Control Register Values
  E001                =1    71     Tmr0CtrlVal     EQU     0E001H          ;value to write to Timer 0 Control Register
                      =1    72                                             ;1---------------  enable timer
                      =1    73                                             ;-1--------------  write to control
                      =1    74                                             ;--1-------------  enable interrupts
                      =1    75                                             ;----000000------  reserved
                      =1    76                                             ;---0------0-----  read only
                      =1    77                                             ;-----------0----  TMRIN0 is an enable
                      =1    78                                             ;------------0---  disable prescaler
                      =1    79                                             ;-------------0--  disable external clock
                      =1    80                                             ;--------------0-  single counter mode
                      =1    81                                             ;---------------1  continuous mode
                      =1    82     
                      =1    83     
                      =1    84     ; Interrupt Vectors
  0008                =1    85     Tmr0Vec         EQU     8               ;interrupt vector for Timer 0
                      =1    86     
                      =1    87     
                      =1    88     ; Interrupt Controller Definitions
                      =1    89     
                      =1    90     ; Addresses
  FF32                =1    91     INTCtrlrCtrl    EQU     0FF32H          ;address of interrupt controller for timer
  FF22                =1    92     INTCtrlrEOI     EQU     0FF22H          ;address of interrupt controller EOI register
                      =1    93     
                      =1    94     ; Register Values
  0001                =1    95     INTCtrlrCVal    EQU     00001H          ;set priority for timers to 1 and enable
                      =1    96                                             ;000000000000----  reserved
                      =1    97                                             ;------------0---  enable timer interrupt
                      =1    98                                             ;-------------001  timer priority
  0008                =1    99     TimerEOI        EQU     00008H          ;Timer EOI command (same for all timers)
  8000                =1   100     NonSpecEOI      EQU     08000H          ;Non-specific EOI command
                      =1   101     
                      =1   102     
                      =1   103     ; Timing Definitions
                      =1   104     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    3


LOC  OBJ                  LINE     SOURCE

  0900                =1   105     COUNTS_PER_MS   EQU     2304            ;number of timer counts per 1 ms (assumes 18.
                                   432 MHz clock)
  0001                =1   106     MS_PER_INT      EQU     1             ;number of ms for each segment
                      =1   107     
                      =1   108     
                           109     
                           110     CGROUP GROUP CODE
                           111     DGROUP GROUP DATA
                           112     
                           113     
----                       114     CODE SEGMENT PUBLIC 'CODE'
                           115     
                           116             ASSUME  CS:CGROUP, DS:DGROUP
                           117     
                           118     ; elapsed_time
                           119     ;
                           120     ; Description:       This procedure returns the elapsed time in ms since the last fun
                                   ction call
                           121     ;
                           122     ; Operation:         returns msElapsed, resets it to 0
                           123     ;
                           124     ; Arguments:         None.
                           125     ; Return Value:      ms elapsed since last call
                           126     ;
                           127     ; Local Variables:   None.
                           128     ; Shared Variables:  msElapsed
                           129     ;
                           130     ; Input:            None.
                           131     ; Output:            None.
                           132     ;
                           133     ; Error Handling:    None.
                           134     ;
                           135     ; Algorithms:        None.
                           136     ; Data Structures:   None.
                           137     ;
                           138     ; Registers Changed: None
                           139     ; Stack Depth:       0 words
                           140     ;
                           141     ; Last Modified:     5-30-2008
                           142     
0000                       143     elapsed_time       PROC    NEAR
                           144                                             PUBLIC elapsed_time
                           145                     
0000 A10000         R      146                     MOV AX, msElapsed
                           147                     
0003 C70600000000   R      148                     MOV msElapsed, 0        ;reset counter
                           149             
0009 C3                    150                     RET
                           151     
                           152     elapsed_time ENDP
                           153     
                           154     ; InitElapsedTimer
                           155     ;
                           156     ; Description:       This procedure inits everything for keeping track of elapsed tim
                                   e
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           157     ;
                           158     ; Operation:         Initializes counter, timer0
                           159     ;
                           160     ; Arguments:         None.
                           161     ; Return Value:      None.
                           162     ;
                           163     ; Local Variables:   None.
                           164     ; Shared Variables:  msElapsed
                           165     ;
                           166     ; Input:            None.
                           167     ; Output:            None.
                           168     ;
                           169     ; Error Handling:    None.
                           170     ;
                           171     ; Algorithms:        None.
                           172     ; Data Structures:   None.
                           173     ;
                           174     ; Registers Changed: None
                           175     ; Stack Depth:       3 words
                           176     ;
                           177     ; Last Modified:     5-30-2008
                           178     
000A                       179     InitElapsedTimer       PROC    NEAR
                           180                                             PUBLIC InitElapsedTimer
                           181                                     
000A E83D00                182                     CALL InstallHandlerT0
000D E81700                183                     CALL InitTimer0
0010 C70600000000   R      184                     MOV msElapsed, 0
                           185             
                           186     
0016 C3                    187                     RET
                           188     
                           189     InitElapsedTimer ENDP
                           190     
                           191     ; Timer0EventHandler
                           192     ;
                           193     ; Description:       This procedure is the event handler for the timer 0
                           194     ;                    interrupt.   It keeps track of the elapsed time
                           195     ;
                           196     ; Operation:         increments msElapsed
                           197     ;
                           198     ; Arguments:         None.
                           199     ; Return Value:      None.
                           200     ;
                           201     ; Local Variables:   None.
                           202     ; Shared Variables:  msElapsed.
                           203     
                           204     ; Input:             None.
                           205     ; Output:            None.
                           206     ;
                           207     ; Error Handling:    None.
                           208     ;
                           209     ; Algorithms:        None.
                           210     ; Data Structures:   None.
                           211     ;
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    5


LOC  OBJ                  LINE     SOURCE

                           212     ; Registers Changed: None
                           213     ; Stack Depth:       3 words
                           214     ;
                           215     ; Author:            Samuel Yang
                           216     ; Last Modified:     5-30-2008
                           217     
0017                       218     Timer0EventHandler       PROC    NEAR
                           219                                             PUBLIC Timer0EventHandler
0017 50                    220                     PUSH AX                         ;save register values
0018 52                    221                     PUSH DX
                           222                     
0019 FF060000       R      223                     INC msElapsed
                           224     
001D                       225     EndTimerEventHandler:                   ;done taking care of the timer
                           226     
001D BA22FF                227             MOV     DX, INTCtrlrEOI         ;send the EOI to the interrupt controller
0020 B80800                228             MOV     AX, TimerEOI
0023 EE                    229             OUT     DX, AL
                           230      
0024 5A                    231                     POP DX                                                  ;restore regi
                                   ster values
0025 58                    232                     POP AX
0026 CF                    233             IRET                            ;and return (Event Handlers end with IRET not
                                    RET)
                           234     
                           235     
                           236     Timer0EventHandler       ENDP
                           237     
                           238     
                           239     
                           240     
                           241     
                           242     ; InitTimer0
                           243     ;
                           244     ; Description:       Initialize the 80188 Timers.  The timers are initialized
                           245     ;                    to generate interrupts every MS_PER_INT milliseconds.
                           246     ;                    The interrupt controller is also initialized to allow the
                           247     ;                    timer interrupts.  Timer #2 is used to prescale the
                           248     ;                    internal clock from 2.304 MHz to 1 KHz.  Timer #0 then
                           249     ;                    counts MS_PER_INT timer #2 intervals to generate the
                           250     ;                    interrupts.
                           251     ;
                           252     ; Operation:         The appropriate values are written to the timer control
                           253     ;                    registers in the PCB.  Also, the timer count registers
                           254     ;                    are reset to zero.  Finally, the interrupt controller is
                           255     ;                    setup to accept timer interrupts and any pending
                           256     ;                    interrupts are cleared by sending a TimerEOI to the
                           257     ;                    interrupt controller.
                           258     ;
                           259     ; Arguments:         None.
                           260     ; Return Value:      None.
                           261     ;
                           262     ; Local Variables:   None.
                           263     ; Shared Variables:  None.
                           264     ; Global Variables:  None.
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           265     ;
                           266     ; Input:             None.
                           267     ; Output:            None.
                           268     ;
                           269     ; Error Handling:    None.
                           270     ;
                           271     ; Algorithms:        None.
                           272     ; Data Structures:   None.
                           273     ;
                           274     ; Registers Changed: AX, DX
                           275     ; Stack Depth:       0 words
                           276     ;
                           277     ; Author:            Glen George
                           278     ; Last Modified:     Oct. 29, 1997
                           279     
0027                       280     InitTimer0       PROC    NEAR
                           281                             PUBLIC InitTimer0
                           282     
                           283                         ;initialize Timer #0 for MS_PER_INT*COUNTS_PER_MS ms interrupts
0027 BA50FF                284             MOV     DX, Tmr0Count   ;initialize the count register to 0
002A 33C0                  285             XOR     AX, AX
002C EE                    286             OUT     DX, AL
                           287     
002D BA52FF                288             MOV     DX, Tmr0MaxCntA ;setup max count for milliseconds per segment
0030 B80009                289             MOV     AX, MS_PER_INT*COUNTS_PER_MS  ;   count so can time the segments
0033 EE                    290             OUT     DX, AL
                           291     
0034 BA56FF                292             MOV     DX, Tmr0Ctrl    ;setup the control register, interrupts on
0037 B801E0                293             MOV     AX, Tmr0CtrlVal
003A EE                    294             OUT     DX, AL
                           295     
                           296                                     ;initialize interrupt controller for timers
003B BA32FF                297             MOV     DX, INTCtrlrCtrl;setup the interrupt control register
003E B80100                298             MOV     AX, INTCtrlrCVal
0041 EE                    299             OUT     DX, AL
                           300     
0042 BA22FF                301             MOV     DX, INTCtrlrEOI ;send a timer EOI (to clear out controller)
0045 B80800                302             MOV     AX, TimerEOI
0048 EE                    303             OUT     DX, AL
                           304     
                           305     
0049 C3                    306             RET                     ;done so return
                           307     
                           308     
                           309     InitTimer0       ENDP
                           310     
                           311     
                           312     
                           313     
                           314     ; InstallHandlerT0
                           315     ;
                           316     ; Description:       Install the event handler for the timer interrupt.
                           317     ;
                           318     ; Operation:         Writes the address of the timer event handler to the
                           319     ;                    appropriate interrupt vector.
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    7


LOC  OBJ                  LINE     SOURCE

                           320     ;
                           321     ; Arguments:         None.
                           322     ; Return Value:      None.
                           323     ;
                           324     ; Local Variables:   None.
                           325     ; Shared Variables:  None.
                           326     ; Global Variables:  None.
                           327     ;
                           328     ; Input:             None.
                           329     ; Output:            None.
                           330     ;
                           331     ; Error Handling:    None.
                           332     ;
                           333     ; Algorithms:        None.
                           334     ; Data Structures:   None.
                           335     ;
                           336     ; Registers Changed: flags, AX, ES
                           337     ; Stack Depth:       0 words
                           338     ;
                           339     ; Author:            Glen George
                           340     ; Last Modified:     Jan. 28, 2002
                           341     
004A                       342     InstallHandlerT0  PROC    NEAR
                           343                             PUBLIC InstallHandlerT0
                           344     
                           345     
004A 33C0                  346             XOR     AX, AX          ;clear ES (interrupt vectors are in segment 0)
004C 8EC0                  347             MOV     ES, AX
                           348                                     ;store the vector
004E 26C70620001700 R      349             MOV     ES: WORD PTR (4 * Tmr0Vec), OFFSET(Timer0EventHandler)
0055 26C7062200---- R      350             MOV     ES: WORD PTR (4 * Tmr0Vec + 2), SEG(Timer0EventHandler)
                           351     
                           352     
005C C3                    353             RET                     ;all done, return
                           354     
                           355     
                           356     InstallHandlerT0  ENDP
                           357     
                           358     
                           359     
                           360     
                           361     
                           362     
----                       363     CODE ENDS
                           364     
                           365     ;the data segment
                           366     
----                       367     DATA    SEGMENT PUBLIC  'DATA'
0000 ????                  368     msElapsed DW ?
                           369     
                           370     
----                       371     DATA    ENDS
                           372     
                           373     
                           374     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    03:37:33  06/01/:8  PAGE    8


LOC  OBJ                  LINE     SOURCE

                           375     
                           376             END     

ASSEMBLY COMPLETE, NO ERRORS FOUND
