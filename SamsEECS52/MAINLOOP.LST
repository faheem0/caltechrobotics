iC-86  COMPILER   MAINLOOP                                                                   06/12/:8 02:13:41  PAGE   1


DOS 5.0 (038-N) iC-86 COMPILER V4.0, COMPILATION OF MODULE MAINLOOP
OBJECT MODULE PLACED IN MAINLOOP.OBJ
COMPILER INVOKED BY: C:\ASMSTU~1\IC86.EXE MAINLOOP.C DEBUG EXTEND MOD186 SMALL OPTIMIZE(0) ROM

 line level  incl 

    1             /****************************************************************************/
    2             /*                                                                          */
    3             /*                                 MAINLOOP                                 */
    4             /*                             Main Program Loop                            */
    5             /*                            MP3 Jukebox Project                           */
    6             /*                                 EE/CS 52                                 */
    7             /*                                                                          */
    8             /****************************************************************************/
    9             
   10             /*
   11                This file contains the main processing loop (background) for the MP3
   12                Jukebox Project.  The only global function included is:
   13                   main - background processing loop
   14             
   15                The local functions included are:
   16                   key_lookup - get a key and look up its keycode
   17             
   18                The locally global variable definitions included are:
   19                   none
   20             
   21             
   22                Revision History
   23                   6/5/00   Glen George       Initial revision (from 3/6/99 version of
   24                                              mainloop.c for the Digital Audio Recorder
   25                                              Project).
   26                   6/2/02   Glen George       Updated comments.
   27                   5/15/03  Glen George       Moved static declarations to first keyword
   28                                              since the lame NIOS compiler requires it.
   29                   5/15/03  Glen George       Changed type on some variables to size_t
   30                                              for better portability and more accurate
   31                              typing.
   32                   5/15/03  Glen George       Added #include of stddef.h to get some
   33                                              standard definitions.
   34                   6/5/03   Glen George       Removed references to track number, it is no
   35                                          longer used.
   36                   6/5/03   Glen George       Added initialization to FAT directory system.
   37                   6/5/03   Glen George       Updated function headers.
   38                   6/11/08 Samuel Yang        Added pause_Play() function to state machine
   39             */
   40             
   41             
   42             
   43             /* library include files */
   44             #include  <stddef.h>
   45             
   46             /* local include files */
   47             #include  "interfac.h"
   48             #include  "mp3defs.h"
   49             #include  "keyproc.h"
   50             #include  "updatfnc.h"
   51             #include  "trakutil.h"
iC-86  COMPILER   MAINLOOP                                                                   06/12/:8 02:13:41  PAGE   2


   52             #include  "fatutil.h"
   53             
   54             
   55             
   56             
   57             /* local function declarations */
   58             enum keycode  key_lookup(void);      /* translate key values into keycodes */
   59             
   60             
   61             
   62             
   63             /*
   64                main
   65             
   66                Description:      This procedure is the main program loop for the MP3
   67                                  Jukebox.  It loops getting keys from the keypad,
   68                                  processing those keys as is appropriate.  It also handles
   69                                  updating the display and setting up the buffers for MP3
   70                                  playback.
   71             
   72                Arguments:        None.
   73                Return Value:     (int) - return code, always 0 (never returns).
   74             
   75                Input:            Keys from the keypad.
   76                Output:           Status information to the display.
   77             
   78                Error Handling:   Invalid input is ignored.
   79             
   80                Algorithms:       The function is table-driven.  The processing routines
   81                                  for each input are given in tables which are selected
   82                                  based on the context (state) in which the program is
   83                                  operating.
   84                Data Structures:  None.
   85             
   86                Shared Variables: None.
   87             
   88                Author:           Glen George
   89                Last Modified:    June 5, 2003
   90             
   91             */
   92             
   93             int  main()
   94             {
   95     1           /* variables */
   96     1           enum keycode  key;                      /* an input key */
   97     1       
   98     1           enum status   cur_status = STAT_IDLE;   /* current program status */
   99     1           enum status   prev_status = STAT_IDLE;  /* previous program status */
  100     1       
  101     1           long int      root_dir_start;       /* start of the root directory */
  102     1       
  103     1           /* array of status type translations (from enum status to #defines) */
  104     1           /* note: the array must match the enum definition order exactly */
  105     1           static const unsigned int  xlat_stat[] =
  106     1               {  STATUS_IDLE,      /* system idle */
  107     1                  STATUS_PLAY,      /* playing (or repeat playing) a track */
  108     1                  STATUS_FASTFWD,   /* fast forwarding a track */
iC-86  COMPILER   MAINLOOP                                                                   06/12/:8 02:13:41  PAGE   3


  109     1                  STATUS_REVERSE    /* reversing a track */
  110     1               };
  111     1       
  112     1           /* update functions (one for each system status type) */
  113     1           static enum status  (* const update_fnc[NUM_STATUS])(enum status) =
  114     1               /*                        Current System Status                           */
  115     1               /*    idle        play      fast forward      reverse      */
  116     1               {  no_update, update_Play, update_FastFwd, update_Reverse  };
  117     1       
  118     1           /* key processing functions (one for each system status type and key) */
  119     1           static enum status  (* const process_key[NUM_KEYCODES][NUM_STATUS])(enum status) =
  120     1               /*                            Current System Status                                           
                -     */
  121     1               /* idle           play            fast forward   reverse                  key         */
  122     1             { {  do_TrackUp,    no_action,      no_action,     no_action     },   /* <Track Up>     */
  123     1               {  do_TrackDown,  no_action,      no_action,     no_action     },   /* <Track Down>   */
  124     1               {  start_Play,    pause_Play,      begin_Play,    begin_Play    },   /* <Play>         */
  125     1               {  start_RptPlay, cont_RptPlay,   begin_RptPlay, begin_RptPlay },   /* <Repeat Play>  */
  126     1               {  start_FastFwd, switch_FastFwd, stop_FFRev,    begin_FastFwd },   /* <Fast Forward> */
  127     1               {  start_Reverse, switch_Reverse, begin_Reverse, stop_FFRev    },   /* <Reverse>      */
  128     1               {  stop_idle,     stop_Play,      stop_FFRev,    stop_FFRev    },   /* <Stop>         */
  129     1               {  no_action,     no_action,      no_action,     no_action     } }; /* illegal key    */
  130     1       
  131     1       
  132     1       
  133     1           /* first initialize everything */
  134     1           /* initalize FAT directory functions */
  135     1           root_dir_start = init_FAT_system();
  136     1       
  137     1           /* get the first directory entry (file/song) */
  138     1           if (root_dir_start != 0)  {
  139     2           /* have a valid starting sector - get the first directory entry */
  140     2           get_first_dir_entry(root_dir_start);
  141     2           /* and setup the information for the track/file */
  142     2           setup_cur_track_info();
  143     2           }
  144     1           else  {
  145     2               /* had an error - fill with error track information */
  146     2           setup_error_track_info();
  147     2           }
  148     1       
  149     1       
  150     1           /* display track information */
  151     1           display_time(get_track_time());
  152     1           display_title(get_track_title());
  153     1           display_artist(get_track_artist());
  154     1       
  155     1           display_status(xlat_stat[cur_status]);  /* display status */
  156     1       
  157     1       
  158     1           /* infinite loop processing input */
  159     1           while(TRUE)  {
  160     2       
  161     2               /* handle updates */
  162     2               cur_status = update_fnc[cur_status](cur_status);
  163     2       
  164     2       
iC-86  COMPILER   MAINLOOP                                                                   06/12/:8 02:13:41  PAGE   4


  165     2               /* now check for keypad input */
  166     2               if (key_available())  {
  167     3       
  168     3                   /* have keypad input - get the key */
  169     3                   key = key_lookup();
  170     3       
  171     3                   /* execute processing routine for that key */
  172     3                   cur_status = process_key[key][cur_status](cur_status);
  173     3               }
  174     2       
  175     2       
  176     2               /* finally, if the status has changed - display the new status */
  177     2               if (cur_status != prev_status)  {
  178     3       
  179     3                   /* status has changed - update the status display */
  180     3                   display_status(xlat_stat[cur_status]);
  181     3               }
  182     2       
  183     2               /* always remember the current status for next loop iteration */
  184     2               prev_status = cur_status;
  185     2           }
  186     1       
  187     1       
  188     1           /* done with main (never should get here), return 0 */
  189     1           return  0;
  190     1       
  191     1       }
  192             
  193             
  194             
  195             
  196             /*
  197                key_lookup
  198             
  199                Description:      This function gets a key from the keypad and translates
  200                                  the raw keycode to an enumerated keycode for the main
  201                                  loop.
  202             
  203                Arguments:        None.
  204                Return Value:     (enum keycode) - type of the key input on keypad.
  205             
  206                Input:            Keys from the keypad.
  207                Output:           None.
  208             
  209                Error Handling:   Invalid keys are returned as KEYCODE_ILLEGAL.
  210             
  211                Algorithms:       The function uses an array to lookup the key types.
  212                Data Structures:  Array of key types versus key codes.
  213             
  214                Shared Variables: None.
  215             
  216                Author:           Glen George
  217                Last Modified:    May 15, 2003
  218             
  219             */
  220             
  221             static  enum keycode  key_lookup()
iC-86  COMPILER   MAINLOOP                                                                   06/12/:8 02:13:41  PAGE   5


  222             {
  223     1           /* variables */
  224     1       
  225     1           static const enum keycode  keycodes[] = /* array of keycodes */
  226     1               {                                   /* order must match keys array exactly */
  227     1                  KEYCODE_TRACKUP,    /* <Track Up>     */    /* also needs to have extra */
  228     1                  KEYCODE_TRACKDOWN,  /* <Track Down>   */    /* entry for illegal codes */
  229     1                  KEYCODE_PLAY,       /* <Play>         */
  230     1                  KEYCODE_RPTPLAY,    /* <Repeat Play>  */
  231     1                  KEYCODE_FASTFWD,    /* <Fast Forward> */
  232     1                  KEYCODE_REVERSE,    /* <Reverse>      */
  233     1                  KEYCODE_STOP,       /* <Stop>         */
  234     1                  KEYCODE_ILLEGAL     /* other keys     */
  235     1               }; 
  236     1       
  237     1           static const int  keys[] =   /* array of key values */
  238     1               {                        /* order must match keycodes array exactly */
  239     1                  KEY_TRACKUP,    /* <Track Up>     */
  240     1                  KEY_TRACKDOWN,  /* <Track Down>   */
  241     1                  KEY_PLAY,       /* <Play>         */
  242     1                  KEY_RPTPLAY,    /* <Repeat Play>  */
  243     1                  KEY_FASTFWD,    /* <Fast Forward> */
  244     1                  KEY_REVERSE,    /* <Reverse>      */
  245     1                  KEY_STOP        /* <Stop>         */
  246     1               }; 
  247     1       
  248     1           int     key;           /* an input key */
  249     1       
  250     1           size_t  i;             /* general loop index */
  251     1       
  252     1       
  253     1       
  254     1           /* get a key */
  255     1           key = getkey();
  256     1       
  257     1       
  258     1           /* lookup key in keys array */
  259     1           for (i = 0; ((i < (sizeof(keys)/sizeof(int))) && (key != keys[i])); i++);
  260     1       
  261     1       
  262     1           /* return the appropriate key type */
  263     1           return  keycodes[i];
  264     1       
  265     1       }



MODULE INFORMATION:

     CODE AREA SIZE               = 0114H    276D
     CONSTANT AREA SIZE           = 006EH    110D
     DATA AREA SIZE               = 0000H      0D
     MAXIMUM STACK SIZE           = 0016H     22D

iC-86 COMPILATION COMPLETE.      0 WARNINGS,     0 ERRORS
