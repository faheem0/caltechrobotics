8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    21:13:40  06/18/:8  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\ASMSTU~1\ASM86.EXE TIMER.ASM M1 DB EP


LOC  OBJ                  LINE     SOURCE

                             1            NAME  timer
                             2     
                             3     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             4     ;                                                                            ;
                             5     ;                                    timer                                       ;
                             6     ;                           Timer Event Handler                                 
                                       ;
                             7     ;                                                                            ;
                             8     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             9     
                            10     ; Description:      This program an event handler (interrupt service routine).
                            11     ;                   It handles the timer overflow interrupt, keeping track of 
                            12     ;                                       elapsed time for the 80188 mp3 player.
                            13     ;
                            14     ; Input:            None.
                            15     ; Output:           None.
                            16     ; User Interface:   call function: 
                            17     ;                                               elapsed_time()
                            18     ;                                               InitElapsedTimer()
                            19     ; Error Handling:   None.
                            20     ;
                            21     ; Algorithms:       None.
                            22     ; Data Structures:  None.
                            23     ;
                            24     ; Revision History:
                            25     
                            26     ;     5/30/08 copied from EE/CS 51 code
                            27     ;         6/11/08 interrupts only every 10ms
                            28     
                            29     ; local include files
                            30 +1  $INCLUDE(boolean.INC)
                      =1    31     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    32     ;                                                                            ;
                      =1    33     ;                                  boolean.INC                               ;
                      =1    34     ;                             Boolean Definitions                            ;
                      =1    35     ;                                 Include File                               ;
                      =1    36     ;                                                                            ;
                      =1    37     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    38     
                      =1    39     ; This file contains the boolean definitions for all of the assembly code for
                      =1    40     ;       the 80188 MP3 Player.
                      =1    41     ;
                      =1    42     ; Revision History:
                      =1    43     
                      =1    44     ;     5/2/2008 Samuel Yang     
                      =1    45     
                      =1    46     
  0001                =1    47     TRUE EQU 1h
  0000                =1    48     FALSE EQU 0h
                            49 +1  $INCLUDE(timer.INC)
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    21:13:40  06/18/:8  PAGE    2


LOC  OBJ                  LINE     SOURCE

                      =1    50     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    51     ;                                                                            ;
                      =1    52     ;                                  timer.INC                                 ;
                      =1    53     ;                              Timer Definitions                                 ;
                      =1    54     ;                                 Include File                               ;
                      =1    55     ;                                                                            ;
                      =1    56     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    57     
                      =1    58     ; This file contains the definitions for the Timer Event Handler
                      =1    59     ;       program (timer.ASM).
                      =1    60     ;
                      =1    61     ; Revision History:
                      =1    62     
                      =1    63     ;     5/30/2008 Samuel Yang     copied from EE/CS 51 code
                      =1    64     ;     6/11/2008 Samuel Yang     changed Timer 0 to interrupt every 16ms
                      =1    65     
                      =1    66     ; Addresses
  FF56                =1    67     Tmr0Ctrl        EQU     0FF56H          ;address of Timer 0 Control Register
  FF52                =1    68     Tmr0MaxCntA     EQU     0FF52H          ;address of Timer 0 Max Count A Register
  FF50                =1    69     Tmr0Count       EQU     0FF50H          ;address of Timer 0 Count Register
                      =1    70     
                      =1    71     
                      =1    72     ; Control Register Values
  E001                =1    73     Tmr0CtrlVal     EQU     0E001H          ;value to write to Timer 0 Control Register
                      =1    74                                             ;1---------------  enable timer
                      =1    75                                             ;-1--------------  write to control
                      =1    76                                             ;--1-------------  enable interrupts
                      =1    77                                             ;----000000------  reserved
                      =1    78                                             ;---0------0-----  read only
                      =1    79                                             ;-----------0----  TMRIN0 is an enable
                      =1    80                                             ;------------0---  disable prescaler
                      =1    81                                             ;-------------0--  disable external clock
                      =1    82                                             ;--------------0-  single counter mode
                      =1    83                                             ;---------------1  continuous mode
                      =1    84     
                      =1    85     
                      =1    86     ; Interrupt Vectors
  0008                =1    87     Tmr0Vec         EQU     8               ;interrupt vector for Timer 0
                      =1    88     
                      =1    89     
                      =1    90     ; Interrupt Controller Definitions
                      =1    91     
                      =1    92     ; Addresses
  FF32                =1    93     INTCtrlrCtrl    EQU     0FF32H          ;address of interrupt controller for timer
  FF22                =1    94     INTCtrlrEOI     EQU     0FF22H          ;address of interrupt controller EOI register
                      =1    95     
                      =1    96     ; Register Values
  0001                =1    97     INTCtrlrCVal    EQU     00001H          ;set priority for timers to 1 and enable
                      =1    98                                             ;000000000000----  reserved
                      =1    99                                             ;------------0---  enable timer interrupt
                      =1   100                                             ;-------------001  timer priority
  0008                =1   101     TimerEOI        EQU     00008H          ;Timer EOI command (same for all timers)
  8000                =1   102     NonSpecEOI      EQU     08000H          ;Non-specific EOI command
                      =1   103     
                      =1   104     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    21:13:40  06/18/:8  PAGE    3


LOC  OBJ                  LINE     SOURCE

                      =1   105     ; Timing Definitions
                      =1   106     
  0900                =1   107     COUNTS_PER_MS   EQU     2304            ;number of timer counts per 1 ms (assumes 18.
                                   432 MHz clock)
  001C                =1   108     MS_PER_INT      EQU     28             ;number of ms per interrupt
                      =1   109     
                      =1   110     
                           111     
                           112     CGROUP GROUP CODE
                           113     DGROUP GROUP DATA
                           114     
                           115     
----                       116     CODE SEGMENT PUBLIC 'CODE'
                           117     
                           118             ASSUME  CS:CGROUP, DS:DGROUP
                           119     
                           120     ; elapsed_time
                           121     ;
                           122     ; Description:       This procedure returns the elapsed time in ms since the last fun
                                   ction call
                           123     ;
                           124     ; Operation:         returns msElapsed, resets it to 0
                           125     ;
                           126     ; Arguments:         None.
                           127     ; Return Value:      ms elapsed since last call
                           128     ;
                           129     ; Local Variables:   None.
                           130     ; Shared Variables:  msElapsed
                           131     ;
                           132     ; Input:             None.
                           133     ; Output:            None.
                           134     ;
                           135     ; Error Handling:    None.
                           136     ;
                           137     ; Algorithms:        None.
                           138     ; Data Structures:   None.
                           139     ;
                           140     ; Registers Changed: None
                           141     ; Stack Depth:       0 words
                           142     ;
                           143     ; Last Modified:     5-30-2008
                           144     
0000                       145     elapsed_time       PROC    NEAR
                           146                                             PUBLIC elapsed_time
                           147                     
0000 A10000         R      148                     MOV AX, msElapsed
                           149                     
0003 C70600000000   R      150                     MOV msElapsed, 0        ;reset counter
                           151             
0009 C3                    152                     RET
                           153     
                           154     elapsed_time ENDP
                           155     
                           156     ; InitElapsedTimer
                           157     ;
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    21:13:40  06/18/:8  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           158     ; Description:       This procedure inits everything for keeping track of elapsed tim
                                   e
                           159     ;
                           160     ; Operation:         Initializes counter, timer0
                           161     ;
                           162     ; Arguments:         None.
                           163     ; Return Value:      None.
                           164     ;
                           165     ; Local Variables:   None.
                           166     ; Shared Variables:  msElapsed
                           167     ;
                           168     ; Input:            None.
                           169     ; Output:            None.
                           170     ;
                           171     ; Error Handling:    None.
                           172     ;
                           173     ; Algorithms:        None.
                           174     ; Data Structures:   None.
                           175     ;
                           176     ; Registers Changed: None
                           177     ; Stack Depth:       0 words
                           178     ;
                           179     ; Last Modified:     5-30-2008
                           180     
000A                       181     InitElapsedTimer       PROC    NEAR
                           182                                             PUBLIC InitElapsedTimer
                           183                                     
000A E83E00                184                     CALL InstallHandlerT0   ;initialize event handler
000D E81800                185                     CALL InitTimer0                 ;initialize timer
0010 C70600000000   R      186                     MOV msElapsed, 0                ;reset timer    
                           187     
0016 C3                    188                     RET
                           189     
                           190     InitElapsedTimer ENDP
                           191     
                           192     ; Timer0EventHandler
                           193     ;
                           194     ; Description:       This procedure is the event handler for the timer 0
                           195     ;                    interrupt.   It keeps track of the elapsed time
                           196     ;
                           197     ; Operation:         increments msElapsed
                           198     ;
                           199     ; Arguments:         None.
                           200     ; Return Value:      None.
                           201     ;
                           202     ; Local Variables:   None.
                           203     ; Shared Variables:  msElapsed.
                           204     
                           205     ; Input:             None.
                           206     ; Output:            None.
                           207     ;
                           208     ; Error Handling:    None.
                           209     ;
                           210     ; Algorithms:        None.
                           211     ; Data Structures:   None.
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    21:13:40  06/18/:8  PAGE    5


LOC  OBJ                  LINE     SOURCE

                           212     ;
                           213     ; Registers Changed: None
                           214     ; Stack Depth:       3 words
                           215     ;
                           216     ; Author:            Samuel Yang
                           217     ; Last Modified:     6-11-2008
                           218     
0017                       219     Timer0EventHandler       PROC    NEAR
                           220                                             PUBLIC Timer0EventHandler
0017 50                    221                     PUSH AX                         
0018 52                    222                     PUSH DX
                           223                     
0019 830600001C     R      224                     ADD msElapsed, MS_PER_INT               ;update counter
                           225     
001E                       226     EndTimerEventHandler:                   ;done taking care of the timer
                           227     
001E BA22FF                228             MOV     DX, INTCtrlrEOI         ;send the EOI to the interrupt controller
0021 B80800                229             MOV     AX, TimerEOI
0024 EE                    230             OUT     DX, AL
                           231      
0025 5A                    232                     POP DX                                          
0026 58                    233                     POP AX
0027 CF                    234             IRET                  
                           235     
                           236     Timer0EventHandler       ENDP
                           237     
                           238     ; InitTimer0
                           239     ;
                           240     ; Description:       Initializes timer 0 to interrupt every so often to 
                           241     ;                               keep track of elapsed time      
                           242     ;
                           243     ; Operation:         Sets up timer control registers and resets counter.
                           244     ;
                           245     ; Arguments:         None.
                           246     ; Return Value:      None.
                           247     ;
                           248     ; Local Variables:   None.
                           249     ; Shared Variables:  None.
                           250     ;
                           251     ; Input:             None.
                           252     ; Output:            None.
                           253     ;
                           254     ; Error Handling:    None.
                           255     ;
                           256     ; Algorithms:        None.
                           257     ; Data Structures:   None.
                           258     ;
                           259     ; Registers Changed: AX, DX
                           260     ; Stack Depth:       0 words
                           261     ;
                           262     ; Author:            Samuel Yang
                           263     ; Last Modified:     6-11-2008
                           264     
0028                       265     InitTimer0       PROC    NEAR
                           266                             PUBLIC InitTimer0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    21:13:40  06/18/:8  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           267                             
0028 BA50FF                268             MOV     DX, Tmr0Count  
002B 33C0                  269             XOR     AX, AX
002D EE                    270             OUT     DX, AL
                           271     
002E BA52FF                272             MOV     DX, Tmr0MaxCntA ;initialize for MS_PER_INT*COUNTS_PER_MS ms interrupt
                                   s
0031 B800FC                273             MOV     AX, MS_PER_INT*COUNTS_PER_MS
0034 EE                    274             OUT     DX, AL
                           275     
0035 BA56FF                276             MOV     DX, Tmr0Ctrl    
0038 B801E0                277             MOV     AX, Tmr0CtrlVal
003B EE                    278             OUT     DX, AL
                           279     
                           280                                     ;initialize interrupt controller for timers
003C BA32FF                281             MOV     DX, INTCtrlrCtrl;setup the interrupt control register
003F B80100                282             MOV     AX, INTCtrlrCVal
0042 EE                    283             OUT     DX, AL
                           284     
0043 BA22FF                285             MOV     DX, INTCtrlrEOI ;send a timer EOI (to clear out controller)
0046 B80800                286             MOV     AX, TimerEOI
0049 EE                    287             OUT     DX, AL
                           288     
004A C3                    289             RET                  
                           290     
                           291     
                           292     InitTimer0       ENDP
                           293     
                           294     ; InstallHandlerT0
                           295     ;
                           296     ; Description:       Install the event handler for the timer interrupt.
                           297     ;
                           298     ; Operation:         Writes the address of the timer event handler to the
                           299     ;                    appropriate interrupt vector.
                           300     ;
                           301     ; Arguments:         None.
                           302     ; Return Value:      None.
                           303     ;
                           304     ; Local Variables:   None.
                           305     ; Shared Variables:  None.
                           306     ; Global Variables:  None.
                           307     ;
                           308     ; Input:             None.
                           309     ; Output:            None.
                           310     ;
                           311     ; Error Handling:    None.
                           312     ;
                           313     ; Algorithms:        None.
                           314     ; Data Structures:   None.
                           315     ;
                           316     ; Registers Changed: flags, AX, ES
                           317     ; Stack Depth:       0 words
                           318     ;
                           319     ; Author:            Glen George
                           320     ; Last Modified:     Jan. 28, 2002
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    21:13:40  06/18/:8  PAGE    7


LOC  OBJ                  LINE     SOURCE

                           321     
004B                       322     InstallHandlerT0  PROC    NEAR
                           323                             PUBLIC InstallHandlerT0
                           324     
                           325     
004B 33C0                  326             XOR     AX, AX          ;clear ES (interrupt vectors are in segment 0)
004D 8EC0                  327             MOV     ES, AX
                           328                                     ;store the vector
004F 26C70620001700 R      329             MOV     ES: WORD PTR (4 * Tmr0Vec), OFFSET(Timer0EventHandler)
0056 26C7062200---- R      330             MOV     ES: WORD PTR (4 * Tmr0Vec + 2), SEG(Timer0EventHandler)
                           331     
005D C3                    332             RET                   
                           333     
                           334     InstallHandlerT0  ENDP
                           335     
----                       336     CODE ENDS
                           337     
                           338     ;the data segment
                           339     
----                       340     DATA    SEGMENT PUBLIC  'DATA'
0000 ????                  341     msElapsed DW ?                                  ;ms elapsed since last function call
                           342     
----                       343     DATA    ENDS
                           344             END     

ASSEMBLY COMPLETE, NO ERRORS FOUND
